# Export Playwright Test Results to Markdown

$jsonPath = "test-results/results.json"
$outputPath = "TEST_RESULTS.md"

if (-not (Test-Path $jsonPath)) {
    Write-Host "No test results found. Run 'npm test' first." -ForegroundColor Red
    exit 1
}

$results = Get-Content $jsonPath -Raw | ConvertFrom-Json

$passed = ($results.suites | ForEach-Object { $_.specs | Where-Object { $_.tests.results.status -eq "passed" } }).Count
$failed = ($results.suites | ForEach-Object { $_.specs | Where-Object { $_.tests.results.status -eq "failed" } }).Count
$skipped = ($results.suites | ForEach-Object { $_.specs | Where-Object { $_.tests.results.status -eq "skipped" } }).Count
$total = $passed + $failed + $skipped

$passRate = if ($total -gt 0) { [math]::Round(($passed / $total) * 100, 1) } else { 0 }

$content = @"
# Test Results Summary
**Date:** $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
**URL:** https://valiantpicks.com

## Overview
- âœ… **Passed:** $passed
- âŒ **Failed:** $failed
- â­ï¸ **Skipped:** $skipped
- ğŸ“Š **Pass Rate:** $passRate%
- â±ï¸ **Duration:** $([math]::Round($results.stats.duration / 1000, 2))s

---

## Test Suites

"@

foreach ($suite in $results.suites) {
    $suiteName = $suite.title
    $content += "`n### $suiteName`n`n"
    
    foreach ($spec in $suite.specs) {
        foreach ($test in $spec.tests) {
            $testTitle = $test.title
            $status = $test.results[0].status
            $duration = [math]::Round($test.results[0].duration / 1000, 2)
            
            $icon = switch ($status) {
                "passed" { "âœ…" }
                "failed" { "âŒ" }
                "skipped" { "â­ï¸" }
                default { "â“" }
            }
            
            $boldOpen = '**'
            $boldClose = '**'
            $content += "- $icon $boldOpen$testTitle$boldClose (${duration}s)`n"
            
            if ($status -eq "failed" -and $test.results[0].error) {
                $errorMsg = $test.results[0].error.message -split "`n" | Select-Object -First 3
                $content += "  ``````n"
                $content += "  $($errorMsg -join "`n  ")`n"
                $content += "  ``````n"
            }
        }
    }
}

$content += "`n---`n`n**Generated by Playwright Test Automation**`n"

$content | Out-File -FilePath $outputPath -Encoding UTF8
Write-Host "âœ… Test results exported to $outputPath" -ForegroundColor Green
Write-Host "ğŸ“Š Pass Rate: $passRate% ($passed/$total tests)" -ForegroundColor Cyan
